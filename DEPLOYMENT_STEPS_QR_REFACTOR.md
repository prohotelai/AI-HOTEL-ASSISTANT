# ğŸš€ DEPLOYMENT STEPS - Hotel QR System Refactoring

## âš ï¸ CRITICAL: Read This Before Deploying

This refactoring introduces **permanent hotel QR codes**. Once deployed, hotels will have ONE permanent QR code that cannot be regenerated by users.

---

## ğŸ“‹ Pre-Deployment Commands (Run in Order)

### 1. Generate Prisma Client
```bash
npx prisma generate
```
**Expected Output:** âœ” Generated Prisma Client

### 2. Push Database Schema Changes
```bash
# Option A: Using migrations (recommended for production)
npx prisma migrate deploy

# Option B: Direct push (for development/testing)
npx prisma db push
```
**Expected Changes:**
- `Hotel.qrCode` field added (String, unique, nullable)
- `Hotel.qrPayload` field added (String, nullable)
- `HotelQRCode.id` marked as unique (if not already)

### 3. Migrate Existing Hotels
```bash
npx ts-node scripts/migrate-hotel-qr-codes.ts
```
**Expected Output:**
```
ğŸ”„ Starting hotel QR code migration...
ğŸ“Š Found X hotels without QR codes
âœ… Migration Complete!
   Success: X
   Errors: 0
```

### 4. Verify Migration
```sql
-- Run this query to verify all hotels have QR codes
SELECT 
  COUNT(*) as total_hotels,
  COUNT("qrCode") as hotels_with_qr,
  COUNT(*) - COUNT("qrCode") as hotels_without_qr
FROM "Hotel";

-- Should show: hotels_without_qr = 0
```

### 5. Build Application
```bash
npm run build
```
**Check for errors** - should build successfully

---

## ğŸ” Post-Deployment Verification

### Test 1: Admin Dashboard
1. Log in as hotel owner/admin
2. Navigate to `/dashboard/admin/hotel-qr`
3. âœ… Verify QR code displays
4. âœ… Click "Copy URL" - should copy to clipboard
5. âœ… Click "Download PNG" - should download image
6. âœ… Click "Print" - should open print dialog
7. âœ… Verify NO "Generate" or "Regenerate" button exists

### Test 2: QR Validation
1. Copy the QR URL from admin dashboard
2. Open in incognito browser
3. âœ… Should redirect to `/access?qr=...`
4. âœ… Hotel name should display correctly
5. âœ… "Guest Access" and "Staff Access" buttons visible

### Test 3: Legacy QR Support
1. Manually visit `/access?hotelId=<HOTEL_ID>`
2. âœ… Should still work
3. âœ… Yellow warning banner should appear
4. âœ… Warning: "Legacy QR Code Detected"

### Test 4: API Endpoints
```bash
# Test GET endpoint (requires auth)
curl -X GET https://your-domain.com/api/qr/<HOTEL_ID> \
  -H "Cookie: next-auth.session-token=..."

# Test validation endpoint (public)
curl -X POST https://your-domain.com/api/qr/validate \
  -H "Content-Type: application/json" \
  -d '{"qrCode":"<QR_CODE>"}'

# Test deprecated endpoint (should return 410)
curl -X POST https://your-domain.com/api/qr/generate
```

### Test 5: Create New Hotel
1. Sign up as new hotel admin
2. Complete onboarding
3. Navigate to `/dashboard/admin/hotel-qr`
4. âœ… QR code should be displayed immediately
5. âœ… Verify QR was generated during signup

---

## ğŸ”’ Security Checklist

- [ ] QR codes are unique per hotel (database constraint)
- [ ] POST `/api/qr/generate` returns 410 Gone
- [ ] POST `/api/qr/[hotelId]` returns 410 Gone
- [ ] Only GET endpoints are active for QR retrieval
- [ ] Legacy QR format shows deprecation warning
- [ ] System-level regeneration requires admin audit log

---

## ğŸ“Š Monitoring

### Key Metrics to Watch

1. **QR Coverage**
```sql
SELECT 
  ROUND(COUNT("qrCode")::numeric / COUNT(*)::numeric * 100, 2) as qr_coverage_percentage
FROM "Hotel";
-- Should be 100%
```

2. **Legacy QR Usage**
```javascript
// Check application logs for:
"âš ï¸ Legacy QR format detected (hotelId)"
```

3. **410 Response Count**
```bash
# Monitor deprecated endpoint usage
grep "POST /api/qr/generate" access.log | wc -l
grep "410" access.log | grep "/api/qr" | wc -l
```

---

## ğŸš¨ Rollback Plan (If Needed)

### Option 1: Keep New System, Fix Issues
```bash
# If hotels are missing QR codes, run migration again
npx ts-node scripts/migrate-hotel-qr-codes.ts
```

### Option 2: Temporary Rollback (Emergency Only)
```bash
# Revert deployment to previous version
vercel rollback

# OR Git revert
git revert <commit-hash>
git push origin main
```

**Note:** Legacy QR system still functions as backward compatibility is maintained.

---

## âœ… Success Criteria

Deployment is successful if:

1. âœ… All hotels have QR codes (`Hotel.qrCode IS NOT NULL`)
2. âœ… Admin dashboard displays QR correctly
3. âœ… Copy/Download/Print buttons work
4. âœ… QR validation works (scan â†’ access page)
5. âœ… Legacy QR format still supported
6. âœ… Deprecated endpoints return 410
7. âœ… New hotel signup generates QR automatically
8. âœ… No TypeScript errors
9. âœ… Tests pass (if running test suite)
10. âœ… Zero production errors in first hour

---

## ğŸ“ Support Contacts

**If deployment fails:**
1. Check application logs for errors
2. Verify database schema changes applied
3. Run migration script if hotels missing QR
4. Contact system administrator

**For emergency QR regeneration:**
```typescript
import { regenerateHotelQr } from '@/lib/services/hotelQrService'

await regenerateHotelQr(
  hotelId,
  adminUserId,
  'Deployment issue - regenerating QR'
)
```

---

## ğŸ“ Deployment Sign-Off

**Deployer:** _________________  
**Date/Time:** _________________  
**Verification Complete:** â˜ Yes â˜ No  

**Tests Passed:**
- â˜ Admin dashboard loads
- â˜ QR code displays
- â˜ Copy/Download/Print work
- â˜ QR validation works
- â˜ Legacy QR supported
- â˜ Deprecated endpoints return 410
- â˜ New hotel creates QR automatically

**Issues Found:**
_________________________________
_________________________________
_________________________________

**Resolution:**
_________________________________
_________________________________
_________________________________

**Status:** â˜ SUCCESS â˜ ROLLBACK â˜ PARTIAL

---

**âœ¨ After successful deployment, all hotels will have permanent QR identity codes!**
